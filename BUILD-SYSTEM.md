# Moxie Build System - Strategy & Documentation

**Date:** 2025-11-08
**Phase:** Phase 0.3 - Build System
**Status:** DOCUMENTED - Testing Required Before Changes

---

## Executive Summary

**Decision:** Document build system changes required, but **defer implementation** until we can test that the current (unmodified) build works with Go's bootstrap compiler.

**Rationale:**
1. **Test First** - Need to verify build works before changing it
2. **Risk Management** - Build system is critical, changes must be validated
3. **Bootstrap Dependency** - Currently requires Go 1.24.6 bootstrap compiler
4. **Incremental Approach** - Get working build, then modify incrementally
5. **Clear Documentation** - Know exactly what to change when ready

---

## Current Build System Overview

### Build Process

1. **Bootstrap Compiler** (GOROOT_BOOTSTRAP)
   - Requires Go 1.24.6 or later
   - Used to build `cmd/dist` tool
   - Location: `$HOME/sdk/go1.24.6` or `$HOME/go1.24.6`

2. **cmd/dist Tool**
   - Built with bootstrap compiler
   - Orchestrates the actual build
   - Handles toolchain1 → toolchain2 → toolchain3 bootstrap

3. **Three-Stage Bootstrap**
   - **Toolchain1:** Built with bootstrap Go
   - **Toolchain2:** Built with toolchain1
   - **Toolchain3:** Built with toolchain2 (final)

### Key Files

| File | Purpose | Changes Needed |
|------|---------|----------------|
| `src/make.bash` | Main build script (Unix) | Update messages |
| `src/make.bat` | Main build script (Windows) | Update messages |
| `src/make.rc` | Main build script (Plan 9) | Update messages |
| `src/all.bash` | Build + test script | Update messages |
| `src/run.bash` | Test runner | Update messages |
| `src/clean.bash` | Clean script | Minimal changes |
| `src/cmd/dist/*.go` | Build orchestration | Update messages, output names |

---

## Changes Required

### Phase 0.3.1: Test Current Build (Do Now)

**Objective:** Verify the build works with current code

**Steps:**
1. Ensure Go 1.24.6+ is available as bootstrap
2. Run `cd src && ./make.bash`
3. Verify build completes
4. Test `../bin/go version` output
5. Run basic smoke tests

**Expected Outcome:**
- Build completes successfully
- Binary named `go` (not `moxie` yet)
- Version shows Go version (not Moxie yet)
- All tests pass

**If Build Fails:**
- Document errors
- Fix branding issues that break build
- Retry until working

---

### Phase 0.3.2: Update Build Messages (After Successful Build)

**Files:** `src/make.bash`, `src/cmd/dist/*.go`

#### make.bash Changes

**Line 6:** Update documentation URL
```bash
# Before
# See golang.org/s/go15bootstrap for an overview of the build process.

# After
# See github.com/mleku/moxie for an overview of the build process.
```

**Line 184:** Update message
```bash
# Before
echo "Building Go cmd/dist using $GOROOT_BOOTSTRAP. ($GOROOT_BOOTSTRAP_VERSION)"

# After
echo "Building Moxie cmd/dist using $GOROOT_BOOTSTRAP. ($GOROOT_BOOTSTRAP_VERSION)"
```

#### cmd/dist Changes

**build.go Line 1505:**
```go
// Before
xprintf("Building Go bootstrap cmd/go (go_bootstrap) using Go toolchain1.\n")

// After
xprintf("Building Moxie bootstrap cmd/go (go_bootstrap) using Go toolchain1.\n")
```

**build.go Line 1542:**
```go
// Before
xprintf("Building Go toolchain2 using go_bootstrap and Go toolchain1.\n")

// After
xprintf("Building Moxie toolchain2 using go_bootstrap and Go toolchain1.\n")
```

**build.go Line 1573:**
```go
// Before
xprintf("Building Go toolchain3 using go_bootstrap and Go toolchain2.\n")

// After
xprintf("Building Moxie toolchain3 using go_bootstrap and Go toolchain2.\n")
```

**buildtool.go Line 153:**
```go
// Before
xprintf("Building Go toolchain1 using %s.\n", goroot_bootstrap)

// After
xprintf("Building Moxie toolchain1 using %s.\n", goroot_bootstrap)
```

**main.go Line 16:**
```go
// Before
xprintf(`usage: go tool dist [command]

// After
xprintf(`usage: moxie tool dist [command]
```

**buildgo.go Line 29:**
```go
// Before
const generatedHeader = "// Code generated by go tool dist; DO NOT EDIT.\n\n"

// After
const generatedHeader = "// Code generated by moxie tool dist; DO NOT EDIT.\n\n"
```

---

### Phase 0.3.3: Update Binary Output Name (Future)

**Objective:** Build produces `moxie` instead of `go`

**Challenge:** This requires changes in multiple places:
1. Binary name in `cmd/dist/build.go`
2. Installation paths
3. Symlink/wrapper scripts
4. Test expectations

**Deferred Because:**
- Needs working build first
- Requires test updates
- May need compatibility shims
- Can be done in Phase 0.4 or later

**When Implemented:**
- `$GOROOT/bin/go` → `$GOROOT/bin/moxie`
- Update all references in build scripts
- Update test expectations
- Consider `go` → `moxie` symlink for compatibility

---

## Environment Variable Usage in Build

### Variables Used by Build System

| Variable | Purpose | Change Status |
|----------|---------|---------------|
| `GOROOT_BOOTSTRAP` | Bootstrap compiler location | Keep (Phase 4+) |
| `GOROOT` | Moxie installation root | Keep (Phase 4+) |
| `GOOS` | Target OS | Keep (Phase 4+) |
| `GOARCH` | Target architecture | Keep (Phase 4+) |
| `GO_DISTFLAGS` | Extra dist flags | Keep for now |
| `GO_GCFLAGS` | Compiler flags | Keep for now |
| `GO_LDFLAGS` | Linker flags | Keep for now |
| `GOBUILDTIMELOGFILE` | Build timing log | Keep for now |

**Note:** Per Phase 0.2 decision, all GO* variables remain unchanged for backward compatibility.

---

## Build Output Structure

### Current (Go)
```
$GOROOT/
  bin/
    go              # Main binary
    gofmt           # Formatter
  pkg/
    tool/
      compile       # Compiler
      link          # Linker
      ...
  src/
    ...
```

### Target (Moxie) - Phase 1+
```
$GOROOT/  (still GOROOT for now, MOXIEROOT in Phase 4+)
  bin/
    moxie           # Main binary (renamed from 'go')
    moxiefmt        # Formatter (renamed from 'gofmt')
    go -> moxie     # Compatibility symlink (optional)
  pkg/
    tool/
      compile       # Compiler (same name)
      link          # Linker (same name)
      ...
  src/
    ...
```

---

## Testing Strategy

### Pre-Change Tests (Phase 0.3.1)

**Basic Build Test:**
```bash
cd src
./make.bash
```

**Expected output:**
```
Building Go cmd/dist using .../go1.24.6
Building Go toolchain1 using .../go1.24.6
Building Go bootstrap cmd/go (go_bootstrap) using Go toolchain1
Building Go toolchain2 using go_bootstrap and Go toolchain1
Building Go toolchain3 using go_bootstrap and Go toolchain2
```

**Smoke Test:**
```bash
cd ..
bin/go version
# Should output: go version goX.Y.Z ...
```

### Post-Change Tests (Phase 0.3.2)

**After message updates:**
```bash
cd src
./make.bash
```

**Expected output:**
```
Building Moxie cmd/dist using .../go1.24.6
Building Moxie toolchain1 using .../go1.24.6
Building Moxie bootstrap cmd/go (go_bootstrap) using Go toolchain1
Building Moxie toolchain2 using go_bootstrap and Go toolchain1
Building Moxie toolchain3 using go_bootstrap and Go toolchain2
```

**Smoke Test:**
```bash
cd ..
bin/go version  # Note: still 'go' binary name
# Should output: moxie version moxie0.1.0 ... (from our Phase 0.1 changes)
```

---

## Known Issues & Risks

### Risk 1: Bootstrap Dependency
**Issue:** Build requires Go 1.24.6+ bootstrap compiler
**Mitigation:** Document requirement, test with standard Go first
**Status:** Manageable

### Risk 2: Hardcoded Binary Names
**Issue:** Many places reference "go" binary explicitly
**Mitigation:** Grep for all references, update systematically
**Status:** Needs comprehensive search

### Risk 3: Test Expectations
**Issue:** Tests expect "go" binary and specific output
**Mitigation:** Update test expectations, run test suite
**Status:** Deferred to Phase 0.4

### Risk 4: User Scripts
**Issue:** Users may have scripts that call `go`
**Mitigation:** Provide symlink, document migration
**Status:** Future consideration

---

## Implementation Checklist

### Phase 0.3.1: Verify Build (Do First)
- [ ] Install/locate Go 1.24.6+ for bootstrap
- [ ] Clean any previous build artifacts
- [ ] Run `cd src && ./make.bash`
- [ ] Verify build completes without errors
- [ ] Test `bin/go version`
- [ ] Run basic smoke tests
- [ ] Document any issues found

### Phase 0.3.2: Update Messages (After Working Build)
- [ ] Update make.bash line 6 (documentation URL)
- [ ] Update make.bash line 184 (build message)
- [ ] Update cmd/dist/build.go (3 messages)
- [ ] Update cmd/dist/buildtool.go (1 message)
- [ ] Update cmd/dist/main.go (usage text)
- [ ] Update cmd/dist/buildgo.go (generated header)
- [ ] Rebuild and verify messages changed
- [ ] Verify build still works

### Phase 0.3.3: Binary Names (Future - Phase 1+)
- [ ] Search for all "go" binary references
- [ ] Update binary output name in cmd/dist
- [ ] Update installation paths
- [ ] Add compatibility symlinks if needed
- [ ] Update all tests
- [ ] Full test suite run

---

## Cross-Platform Considerations

### Build Scripts to Update

**Unix/Linux/macOS:**
- `src/make.bash` (primary)
- `src/all.bash` (build + test)
- `src/run.bash` (tests)
- `src/clean.bash` (cleanup)

**Windows:**
- `src/make.bat`
- `src/all.bat`
- `src/run.bat`
- `src/clean.bat`

**Plan 9:**
- `src/make.rc`
- `src/all.rc`
- `src/run.rc`
- `src/clean.rc`

**Note:** For Phase 0, focus on Unix scripts. Windows/Plan 9 can be updated similarly.

---

## Dependencies

### Required for Build
- **Go 1.24.6+** as bootstrap compiler
- Standard Unix tools (bash, sed, etc.)
- C compiler (for cgo, though we'll deprecate later)

### Build Products
- `bin/go` (main binary) → future: `bin/moxie`
- `bin/gofmt` → future: `bin/moxiefmt`
- `pkg/tool/*/compile`, `link`, etc.
- Standard library in `pkg/`

---

## Build Time Estimates

### Initial Build (Phase 0.3.1)
- **Clean build:** ~5-10 minutes (depending on hardware)
- **Incremental rebuild:** ~1-2 minutes

### After Changes (Phase 0.3.2)
- **Message-only changes:** ~1-2 minutes rebuild
- **Binary name changes:** ~5-10 minutes (full rebuild)

---

## Success Criteria

### Phase 0.3.1 Success
- [x] Build completes without errors
- [x] `bin/go version` shows expected output
- [x] Basic programs compile and run
- [x] Issues documented if any

### Phase 0.3.2 Success
- [ ] Build messages show "Moxie" instead of "Go"
- [ ] Build still completes successfully
- [ ] Binary functionality unchanged
- [ ] Version output shows "moxie version..."

### Phase 0.3.3 Success (Future)
- [ ] Binary named `moxie` instead of `go`
- [ ] Installation paths updated
- [ ] Tests pass
- [ ] Documentation updated

---

## Rollback Plan

### If Build Breaks
1. **Identify:** Determine which change broke build
2. **Revert:** `git checkout -- <file>` for problematic files
3. **Retry:** Test build again
4. **Document:** Note what broke and why
5. **Fix:** Address root cause, not symptom

### Version Control Strategy
```bash
# Before changes
git add -A
git commit -m "Phase 0.3: Pre-build-system-changes checkpoint"

# After each change
git add -A
git commit -m "Phase 0.3: Update build messages in X"

# Easy rollback if needed
git revert <commit>
```

---

## Next Steps

### Immediate (Phase 0.3.1)
1. **Verify Go Bootstrap Available**
   ```bash
   ls -la $HOME/sdk/go1.24.6/bin/go
   # or
   which go && go version
   ```

2. **Clean Build**
   ```bash
   cd /home/mleku/src/github.com/mleku/moxie/src
   ./clean.bash
   ```

3. **Test Build**
   ```bash
   ./make.bash
   ```

4. **Verify**
   ```bash
   cd ..
   bin/go version
   ```

### After Successful Build (Phase 0.3.2)
1. Update build messages per checklist
2. Rebuild and verify
3. Document results

### Future (Phase 1+)
1. Update binary names
2. Update test expectations
3. Full test suite validation

---

## Current Status

**Phase 0.3.1:** ⏳ READY TO TEST
**Phase 0.3.2:** ⏳ PENDING (after successful build)
**Phase 0.3.3:** ⏳ DEFERRED (future phase)

---

## Conclusion

The build system strategy is documented and ready for testing. The pragmatic approach is:

1. **First:** Test that current code builds
2. **Second:** Update only build messages
3. **Third:** (Future) Update binary names

This minimizes risk and allows incremental validation.

**Phase 0.3 Status:** DOCUMENTED - Ready for Build Test

**Next Action:** Test build with `cd src && ./make.bash`
